"""
兼容性适配器

保持与原有洪涝灾害模板的兼容性。
"""

from typing import Dict, Any, List, Optional
from .base import BaseTemplate


class LegacyFloodTemplate(BaseTemplate):
    """洪涝灾害模板的兼容性适配器"""
    
    def __init__(self):
        super().__init__()
    
    def load_schema(self) -> Dict[str, Any]:
        """加载洪涝灾害的输出schema"""
        return {
            "type": "object",
            "properties": {
                "基础实体": {
                    "type": "array",
                    "items": {
                        "type": "object",
                        "properties": {
                            "类型": {"type": "string", "enum": ["事件", "地点", "设施"]},
                            "名称": {"type": "string"},
                            "唯一ID": {"type": "string"},
                            "地理描述": {"type": "string"}
                        },
                        "required": ["类型", "名称", "唯一ID"]
                    }
                },
                "状态实体": {
                    "type": "array",
                    "items": {
                        "type": "object",
                        "properties": {
                            "类型": {"type": "string", "enum": ["独立状态", "联合状态"]},
                            "关联实体ID列表": {"type": "array", "items": {"type": "string"}},
                            "状态ID": {"type": "string"},
                            "时间": {"type": "string"},
                            "状态描述": {"type": "object"}
                        },
                        "required": ["类型", "关联实体ID列表", "状态ID", "时间", "状态描述"]
                    }
                },
                "状态关系": {
                    "type": "array",
                    "items": {
                        "type": "object",
                        "properties": {
                            "主体状态ID": {"type": "string"},
                            "关系": {"type": "string", "enum": ["触发", "影响", "调控", "导致"]},
                            "客体状态ID": {"type": "string"},
                            "依据": {"type": "string"}
                        },
                        "required": ["主体状态ID", "关系", "客体状态ID", "依据"]
                    }
                }
            },
            "required": ["基础实体", "状态实体", "状态关系"]
        }
    
    def create_prompt(self, **kwargs) -> List[Dict[str, str]]:
        """创建洪涝灾害提示（保持原有逻辑）"""
        
        # 使用原有的详细提示模板
        system_prompt = self._get_flood_system_prompt()
        user_prompt = self._get_flood_user_prompt(**kwargs)
        
        return [
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_prompt}
        ]
    
    def _get_flood_system_prompt(self) -> str:
        """获取洪涝灾害系统提示"""
        return """**角色与任务**

你是一个高度专业化的信息抽取引擎，专为洪涝灾害领域设计。你的核心任务是**精确、无遗漏地**从给定文本中抽取出符合下列严格定义的实体、状态和关系，并以指定的JSON格式输出。**准确性和对规则的绝对遵守是最高优先级。**

---

### **一、核心原则（必须严格遵守）**

1.  **忠于原文 (Grounding in Source)**: **仅能**提取文本中明确陈述或可直接、无歧义推断的信息。**严禁**引入任何外部知识（如，根据其他文档推断事实），除非是通用地理编码（如"南宁市"对应"450100"）。
2.  **确定性优先 (Certainty First)**: 如果对某项信息的提取（实体、状态、关系）存在任何模糊或不确定性，**必须放弃提取**。宁可漏提，也不可错提。
3.  **无情景假设 (No Assumptions)**: 不要对文本中未明确提及的时间、地点或因果关系进行猜测。例如，如果一个状态没有明确的时间，则不能提取。
4.  **完整性扫描 (Complete Coverage)**: 必须扫描全文，确保**所有**符合定义的事件、地点（行政区、自然地理实体）、设施、状态及其关系都被提取。特别注意不要遗漏对河流、湖泊等自然实体的状态描述。
5.  **遵循上下文 (Context is Key)**: 必须利用文本中的**所有**上下文线索，如图表标题、章节标题（如"（三）全年灾情统计"）、脚注等，来确定信息（尤其是时间范围）的正确归属。

---

### **二、实体与状态定义**

#### **A. 基础实体定义**

| 实体类型            | 定义                                                         | 示例                               | 明确排除项                                       |
| :------------------ | :----------------------------------------------------------- | :--------------------------------- | :----------------------------------------------- |
| **事件 (Event)**    | 直接导致或由洪涝灾害引发的具体自然或衍生现象。**必须**能与文本中特定的时间和地点绑定。 | `2023年长江流域暴雨`、`某水库决堤` | 泛指（"洪水"）、常规活动（"每日简报"）。         |
| **地点 (Location)** | **1. 自然地理实体**（河流、湖泊等）或 **2. 行政区域**（省、市、区、乡镇）。必须与事件相关，并使用文本中**最具体**的名称。 | `长江`、`鄱阳湖`、`湖北省武汉市`   | 非特定位置（"下游"）、非行政单元（"北京西路"）。 |
| **设施 (Facility)** | 具有**具体名称**的、参与水利或救灾的**人造结构**。           | `三峡大坝`、`湘江水文站`           | 未命名结构（"一座泵站"）、自然实体（`长江`）。   |

#### **B. 状态实体定义**

* **独立状态 (Independent State)**: 描述**单一**基础实体在特定时空下的状况。
* **联合状态 (Joint State)**: 描述**多个**基础实体不可分割的共享状态（如"南宁、北海两市总损失..."）。**注意**：仅针对单个高级行政区（如"广西全区"）的统计数据是其自身的**独立状态**，除非文本明确指出这是其下属多个具体市县的联合统计。

---

### **三、输出格式**

请严格按照以下JSON格式输出：

```json
{
  "基础实体": [
    {
      "类型": "事件/地点/设施",
      "名称": "标准化名称",
      "唯一ID": "生成的唯一ID",
      "地理描述": "文本中关于地理位置的描述"
    }
  ],
  "状态实体": [
    {
      "类型": "独立状态/联合状态",
      "关联实体ID列表": ["一个或多个基础实体ID"],
      "状态ID": "唯一状态标识符",
      "时间": "YYYY-MM-DD至YYYY-MM-DD",
      "状态描述": {
        "扁平化属性1": "值1",
        "扁平化属性2": "值2"
      }
    }
  ],
  "状态关系": [
    {
      "主体状态ID": "原因状态的ID",
      "关系": "关系类型",
      "客体状态ID": "结果状态的ID",
      "依据": "原文中支持该关系的关键句"
    }
  ]
}
```"""
    
    def _get_flood_user_prompt(self, **kwargs) -> str:
        """获取洪涝灾害用户提示"""
        chunk = kwargs.get('chunk', '')
        doc_name = kwargs.get('doc_name', '未知文档')
        
        return f"""请严格遵循以上所有原则、定义、流程和格式，处理以下文本。返回唯一的、格式正确的JSON输出，不要包含任何解释性文字。

来源文档: 《{doc_name}》

待处理文本:

{chunk}"""